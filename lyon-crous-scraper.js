const axios = require('axios');
const cheerio = require('cheerio');
const fs = require('fs');

// ===== CONFIGURATION LYON =====

const priorityResidences = [
  'Benjamin Delessert',
  'Claude Bernard',
  'Condorcet',
  'Jussieu',
  'Allix',
  'Mermoz',
  'AndrÃ© Lirondelle',
  'Le Mail',
  'Voltaire',
  'Paul Bert',
  'Confluence'
];

const CAMPUS_REFERENCE_COORDS = {
  lat: 45.7827,
  lng: 4.8771,
  name: 'Campus La Doua - UniversitÃ© Lyon 1',
  address: '43 Boulevard du 11 Novembre 1918, 69100 Villeurbanne'
};

const RESIDENCE_COORDS = {
  'Benjamin Delessert': { lat: 45.7480, lng: 4.8460 },
  'Claude Bernard': { lat: 45.7800, lng: 4.8750 },
  'Condorcet': { lat: 45.7650, lng: 4.8600 },
  'Jussieu': { lat: 45.7720, lng: 4.8680 },
  'Allix': { lat: 45.7550, lng: 4.8350 },
  'Mermoz': { lat: 45.7280, lng: 4.8900 },
  'AndrÃ© Lirondelle': { lat: 45.7620, lng: 4.8580 },
  'Le Mail': { lat: 45.7700, lng: 4.8750 },
  'Voltaire': { lat: 45.7600, lng: 4.8500 },
  'Paul Bert': { lat: 45.7570, lng: 4.8550 },
  'Confluence': { lat: 45.7430, lng: 4.8190 },
  'Debourg': { lat: 45.7350, lng: 4.8380 },
  'Part-Dieu': { lat: 45.7610, lng: 4.8560 }
};

// GitHub environment
const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
const GITHUB_REPOSITORY = process.env.GITHUB_REPOSITORY;
const CI_MODE = process.env.CI === 'true' || process.env.GITHUB_ACTIONS === 'true';

// Cache file for tracking sent offers
const SENT_OFFERS_FILE = 'sent_offers.json';

function loadSentOffers() {
  try {
    if (fs.existsSync(SENT_OFFERS_FILE)) {
      return new Set(JSON.parse(fs.readFileSync(SENT_OFFERS_FILE, 'utf8')));
    }
  } catch (e) {
    console.log('No previous cache, starting fresh');
  }
  return new Set();
}

function saveSentOffers(offers) {
  fs.writeFileSync(SENT_OFFERS_FILE, JSON.stringify([...offers], null, 2));
}

let sentOffers = loadSentOffers();

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function estimateTime(distanceKm) {
  return {
    walking: Math.round((distanceKm / 5) * 60),
    biking: Math.round((distanceKm / 15) * 60),
    metro: Math.round((distanceKm / 25) * 60)
  };
}

function getResidenceCoords(residenceName) {
  for (const [key, coords] of Object.entries(RESIDENCE_COORDS)) {
    if (residenceName.toLowerCase().includes(key.toLowerCase())) {
      return coords;
    }
  }
  return { lat: 45.7640, lng: 4.8357 };
}

function generateOfferId(name, link) {
  return `${name.toLowerCase().replace(/\s+/g, '_')}_${link.split('/').pop()}`;
}

// Create GitHub Issue for new housing
async function createGitHubIssue(housingList) {
  if (!GITHUB_TOKEN || !GITHUB_REPOSITORY) {
    console.log('âš ï¸  GitHub not configured, logging to console only');
    return;
  }

  const [owner, repo] = GITHUB_REPOSITORY.split('/');
  const now = new Date().toISOString();
  
  // Sort by distance
  const sorted = housingList.sort((a, b) => a.distance - b.distance);
  
  // Check if any are priority
  const hasPriority = sorted.some(h => h.isPriority);
  const priorityLabel = hasPriority ? 'â­ PRIORITY' : '';
  
  // Build issue body
  let body = `## ğŸ  ${housingList.length} New Housing Found!\n\n`;
  body += `**Time:** ${now}\n`;
  body += `**Reference:** ${CAMPUS_REFERENCE_COORDS.name}\n\n`;
  body += `---\n\n`;
  
  sorted.forEach((h, i) => {
    const priority = h.isPriority ? 'â­ **PRIORITY**' : '';
    body += `### ${i + 1}. ${h.name} ${priority}\n\n`;
    body += `| Info | Value |\n|------|-------|\n`;
    body += `| ğŸ”— Link | [Apply Now](${h.link}) |\n`;
    body += `| ğŸ“ Distance | ${h.distance.toFixed(2)} km |\n`;
    body += `| ğŸš¶ Walking | ${h.timeEstimate.walking} min |\n`;
    body += `| ğŸš´ Biking | ${h.timeEstimate.biking} min |\n`;
    body += `| ğŸš‡ Metro | ${h.timeEstimate.metro} min |\n\n`;
  });
  
  body += `---\n`;
  body += `*Auto-generated by CROUS Lyon Scraper*`;

  // Determine labels
  const labels = ['housing-alert'];
  if (hasPriority) labels.push('priority');
  
  const title = `ğŸ  ${housingList.length} New CROUS Housing ${priorityLabel} - ${new Date().toLocaleDateString('fr-FR')}`;

  try {
    const response = await axios.post(
      `https://api.github.com/repos/${owner}/${repo}/issues`,
      {
        title: title,
        body: body,
        labels: labels
      },
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'CROUS-Lyon-Scraper'
        }
      }
    );
    
    console.log(`âœ… GitHub Issue created: ${response.data.html_url}`);
    return response.data;
  } catch (error) {
    console.error(`âŒ Failed to create issue: ${error.message}`);
    if (error.response) {
      console.error(`   Status: ${error.response.status}`);
      console.error(`   Data: ${JSON.stringify(error.response.data)}`);
    }
    throw error;
  }
}

async function scrapeWebsite() {
  try {
    // Correct Lyon URL - region code 42, bounds from official CROUS search
    const url = 'https://trouverunlogement.lescrous.fr/tools/42/search?bounds=4.7718134_45.8082628_4.8983774_45.7073666';
    
    console.log('\n' + 'â•'.repeat(60));
    console.log(`ğŸ” CROUS Lyon Check - ${new Date().toISOString()}`);
    console.log('â•'.repeat(60));
    
    const { data } = await axios.get(url, {
      timeout: 30000,
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    });
    
    const $ = cheerio.load(data);
    const frCardExists = $('.fr-card').length > 0;
    const aucunLogementTrouve = $('body').text().includes('Aucun logement trouvÃ©');
    
    if (frCardExists) {
      const housingData = [];
      const newOffers = [];
      
      $('.fr-card').each((index, element) => {
        const $card = $(element);
        
        const name = $card.find('.fr-card__title').text().trim() ||
                    $card.find('h3').text().trim() ||
                    $card.find('.fr-card__desc').text().trim() ||
                    'Unknown';
        
        const link = $card.find('a').attr('href') || '';
        const fullLink = link.startsWith('http') ? link : `https://trouverunlogement.lescrous.fr${link}`;
        
        const isPriority = priorityResidences.some(p =>
          name.toLowerCase().includes(p.toLowerCase())
        );
        
        const coords = getResidenceCoords(name);
        const distance = calculateDistance(
          CAMPUS_REFERENCE_COORDS.lat, CAMPUS_REFERENCE_COORDS.lng,
          coords.lat, coords.lng
        );
        
        const offerId = generateOfferId(name, fullLink);
        
        const item = {
          name, link: fullLink, isPriority, id: offerId,
          distance, timeEstimate: estimateTime(distance)
        };
        
        console.log(`ğŸ“ ${name} | ${distance.toFixed(1)}km | ${isPriority ? 'â­' : 'ğŸ“'}`);
        
        housingData.push(item);
        
        if (!sentOffers.has(offerId)) {
          newOffers.push(item);
          sentOffers.add(offerId);
        }
      });
      
      saveSentOffers(sentOffers);
      
      if (newOffers.length > 0) {
        console.log(`\nğŸ†• ${newOffers.length} NEW offers found!`);
        await createGitHubIssue(newOffers);
      } else {
        console.log(`\nğŸ“Š ${housingData.length} total, 0 new`);
      }
      
      return { success: true, newOffers: newOffers.length, total: housingData.length };
      
    } else if (aucunLogementTrouve) {
      console.log('âŒ No housing available');
      return { success: true, newOffers: 0, total: 0 };
    } else {
      console.log('âš ï¸  Parsing issue - check script');
      return { success: false, error: 'Parsing error' };
    }
    
  } catch (error) {
    console.error(`âŒ Error: ${error.message}`);
    return { success: false, error: error.message };
  }
}

async function main() {
  console.log('ğŸš€ CROUS Lyon Scraper');
  console.log(`ğŸ“ Reference: ${CAMPUS_REFERENCE_COORDS.name}`);
  console.log(`ğŸ”„ Mode: ${CI_MODE ? 'GitHub Actions' : 'Local'}`);
  
  if (CI_MODE) {
    const result = await scrapeWebsite();
    process.exit(result.success ? 0 : 1);
  } else {
    // Local: run continuously every 30 seconds
    await scrapeWebsite();
    setInterval(scrapeWebsite, 30000);
  }
}

main();
